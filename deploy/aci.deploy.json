{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "containerGroupName": {
      "type": "string",
      "defaultValue": "mlflowserver-containergroup",
      "metadata": {
        "description": "Container Group name."
      }
    },
    "containerGroupLocation": {
      "defaultValue": "[resourceGroup().location]",
      "type": "string",
      "metadata": {
        "description": "Container group location"
      }
    },
    "storageAccountName": {
      "type": "string",
      "defaultValue": "[concat('stor', uniqueString(resourceGroup().id))]",
      "metadata": {
        "description": "Storage Account Name"
      }
    },
    "storageAccountType": {
      "type": "string",
      "defaultValue": "Standard_LRS",
      "allowedValues": [
        "Standard_LRS",
        "Standard_GRS",
        "Standard_ZRS"
      ],
      "metadata": {
        "description": "Storage Account type"
      }
    },
    "storageLocation": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Storage account location"
      }
    },
    "mlflowServerFileStore": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Mlflow Server File Store (The root of the backing file store for experiment and run data)"
      }
    },
    "mlflowServerDefaultArtifactRoot": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Storage account location"
      }
    }
  },
  "variables": {
    "containerName": "mlflowserver",
    "containerImage": "devlace/mlflowserver-azure",
    "blobContainerName": "mlartefacts",
    "fileshareName": "mlruns",
    "mntPath": "/mnt/mlruns"
  },
  "resources": [{
      "type": "Microsoft.Storage/storageAccounts",
      "name": "[parameters('storageAccountName')]",
      "apiVersion": "2017-10-01",
      "location": "[parameters('storageLocation')]",
      "sku": {
        "name": "[parameters('storageAccountType')]"
      },
      "kind": "Storage",
      "properties": {}
    },
    {
      "name": "[parameters('containerGroupName')]",
      "type": "Microsoft.ContainerInstance/containerGroups",
      "apiVersion": "2018-04-01",
      "location": "[parameters('containerGroupLocation')]",
      "dependsOn": [
        "[concat('Microsoft.Storage/storageAccounts/', parameters('storageAccountName'))]"
      ],
      "properties": {
        "containers": [{
          "name": "[variables('containerName')]",
          "properties": {
            "image": "[variables('containerImage')]",
            "command": [
              "[concat('az storage share create --name ', variables('fileShareName'))]",
              "[concat('az storage container create --name ', variables('blobContainerName'))]"
            ],
            "resources": {
              "requests": {
                "cpu": 1,
                "memoryInGb": 1.5
              }
            },
            "ports": [{
                "port": 5000
              }
            ],
            "environmentVariables": [{
              "name": "AZURE_STORAGE_ACCOUNT",
              "value": "[parameters('storageAccountName')]"
            }, {
              "name": "AZURE_STORAGE_ACCESS_KEY",
              "value": "[listKeys(parameters('storageAccountName'),'2017-10-01').keys[0].value]"
            }, {
              "name": "MLFLOW_SERVER_FILE_STORE",
              "value": "[variables('mntPath')]"
            }, {
              "name": "MLFLOW_SERVER_DEFAULT_ARTIFACT_ROOT",
              "value": "[concat('wasbs://', variables('blobContainerName'), '@', parameters('storageAccountName'), 'blob.core.windows.net/artefacts')]"
            }, {
              "name": "MLFLOW_SERVER_HOST",
              "value": "0.0.0.0"
            }],
            "volumeMounts": [
              {
                "name": "volume-azfile-mlruns",
                "mountPath": "[variables('mntPath')]",
                "readOnly": false
              }
            ]
          }
        }],
        "volumes": [{
          "name": "volume-azfile-mlruns",
          "azureFile": {
            "shareName": "share1",
            "storageAccountName": "myStorageAccount",
            "storageAccountKey": "<storage-account-key>"
          }
        }],
        "osType": "Linux",
        "ipAddress": {
          "type": "Public",
          "ports": [{
            "protocol": "tcp",
            "port": "5000"
          }]
        }
      }
    }
  ],
  "outputs": {
    "containerIPv4Address": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.ContainerInstance/containerGroups/', parameters('containerGroupName'))).ipAddress.ip]"
    }
  }
}